const fs = import "../utils/fs"
const lex = import "../utils/lexer"
const string = import "../utils/string"
const std = import "@stdlib"
const mod = import "./mod"
const grid = import "./grid"

const filename = "./inputs/day04.txt";
// const filename = "./inputs/day04_ex.txt";


pub fn parse_input(): grid::Grid {
	let file = fs::read_file(&filename);
	std::assert(file.success, "Failed to open file\n");

	let lexer = lex::new(file.content, file.length);

	let height = string::line_count(file.content);
	let width = string::count_until(file.content, string::is_whitespace);
	let count = height * width;

	let map: *grid::Tile = std::malloc(sizeof(grid::Tile) * count);
	for let y = 0; y < height; y += 1 {
		for let x = 0; x < width; x += 1 {
			map[x + y*width] = parse_tile(&lexer);
		}
		if y + 1 < height {
			lex::consume(&lexer, '\n');
		}
	}

	std::free(file.content);
	return grid::Grid {
		width, height, map
	};
}


fn parse_tile(lexer: *lex::Lexer): grid::Tile {
	match lex::curr(lexer) {
		'.' => {
			lex::step(lexer);
			return grid::Tile::SPACE;
		}
		'@' => {
			lex::step(lexer);
			return grid::Tile::PAPER;
		}
		_ => {
			std::printf("Unknown tile '%c'\n", lex::curr(lexer));
			lex::print(lexer);
			std::exit(1);
			return grid::Tile::SPACE;
		}
	}
}



